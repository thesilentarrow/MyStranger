{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block tailwind %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
{% endblock tailwind %}
{% block body %}

<style>


	.timestamp-span.hidden {
		display: none!important;
	}


	
	.msg_cont1_timestamp{
		right: 3px;
		bottom: -14px;
		position: absolute;
		font-size: 10px;
		font-weight: 400;
	}
	
	.msg_cont_timestamp{
		left: 3px;
		bottom: -14px;
		position: absolute;
		font-size: 10px;
		font-weight: 400;
	}
	
	{% comment %} .msgbar-container{
		background:grey;
	} {% endcomment %}

	.msg_bar1_timestamp{
		width: 53px;
    left: -64px;
    bottom: 8px;
    position: absolute;
    font-size: 10px;
    font-weight: bold;
    border-radius: 20px;
    background: #e6e6e6;
    display: flex;
    justify-content: center;
	padding: 3px 5px;
	gap:10px;
	

	}
	
	.msg_bar_timestamp{
		
		
	width: 53px;
    right: -64px;
    bottom: 8px;
    position: absolute;
    font-size: 10px;
    font-weight: bold;
    border-radius: 20px;
    background: #e6e6e6;
    display: flex;
    justify-content: center;
	padding: 3px 5px;
	
	}

	.msg_bar_timestamp.hidden {
		display: none!important;
	}
	

	body {
		height: 100vh;
		/* border: 2px solid red; */
		margin: 0;
		padding: 0;
		display: flex;
		flex-direction: column;
		/* overflow: hidden; */
	}

	.main-container {
		/* border: 2px solid blue; */
		flex: 1;

	}


	.right-column {
		border: 1px solid #707070;
		padding: 0px;
	}

	.right-column p {
		margin-bottom: 3px;
		font-size: 16px;
	}

	.cont-row {
		height: 100%;
		/* border: 2px solid green; */
		/* margin: 0px; */
		margin: auto;
		justify-content: center;
		align-items: center;
		
		width: 100%;
	}

	.left-column {
		display: flex;
		flex-direction: column;
		padding: 0px;
		/* padding-left: 5px !important; */
		width: 29vw;

		height: 97%;
		/* margin: auto; */
		/* margin-left: 0px; */
		/* margin-right: 0px; */
	}

	.right-column {
		height: 97%;
		width: 69vw;
		/* margin: auto; */
		position: relative;
		border-radius: 8px;
		margin-left: 8px;
	}


	.upper-left {
		border: 2px solid #707070;
		height: 46%;
		margin-top: 10px;
		width: 100%;
	}

	.lower-left {
		/* border: 2px solid black; */
		height: 46%;
		width: 100%;
		margin-top: 18px;
	}

	video,
	.video {
		border-radius: 8px;
	}

	.right-header {
		display: flex;
		align-items: center;
		justify-content: space-between;
		border-bottom: 1px solid #707070;
		height: 3.5em;
		padding: 1em;
	}

	.right-header img {
		margin-right: 10px;
	}

	.img1 {
		margin-right: 1em;
	}

	.bottom-header {
		margin: auto;
		width: 70%;
		display: flex;
		/* position: absolute; */
		/* bottom: 0.5em; */
		/* left: 15%;` */
		/* border: 2px solid black; */

	}

	.skip-btn {
		width: 72px;
		border-radius: 8px;
		height: 53px;
	}

	.video-textarea {
		border: 1px solid #707070;
		border-radius: 8px;
		margin-left: 5px;
		padding-left: 10px;
		padding-right: 40px;
	}

	.txtarea-cont {
		display: contents;
		position: absolute;
	}

	.send-btn {
		position: absolute;
		right: 13px;
		top: 15px;
	}

	.send-btn-cont {
		border: none;
		color: black;
		background-color: white;
		padding: 0px;
	}

	.status-txt {
		color: #343a40;
		text-align: center;
	}

	.chat-log {
		/* height: 450px; */
		max-height: 65svh;
		overflow-x: hidden;
		overflow-y: auto;
		padding: 10px;
		background-color: #fff;
		font-size: 0.9em;
		flex-direction: column-reverse;
		flex-grow: 1;
	}

	.msg-p {
		font-weight: 450;
		margin-top: 5px;
		margin-bottom: auto;
		margin-left: 5px;
		margin-right: 5px;
		white-space: normal;
		{% comment %} -ms-word-break: break-all;
		word-break: break-all; {% endcomment %}
		word-break: break-word;
	}

	.message-container {
		margin-top: 10px;
		justify-content: start;
		position: relative;
	}
	.message-container1 {
		margin-top: 10px;
		justify-content: end;
		position: relative;
	}

	.username-span {
		font-weight: 600;
		margin-top: 0px;
		margin-bottom: auto;
		margin-left: 5px;
		margin-right: 5px;
	}

	#id_chatroom_card {
		height: 100%;
		/* margin-left: 8px; */
	}

	#id_chat_log_container{
		flex: 1;
	}

	.left-card {
		height: 100%;
		border-radius: 8px;
		border: 1px solid #707070;
	}

	#id_other_username {
		font-size: 18px;
		margin-bottom: 0px;
		color: black;
	}

	.friends {
		justify-content: space-between;
		width: 100%;
		position: relative;
	}

	.notify-badge {
		position: absolute;
		background: red;
		/* border: 2px solid red; */
		height: 1.2rem;
		width: 1.2rem;
		line-height: 1.2rem;
		top: 1rem;
		right: 2rem;
		text-align: center;
		font-size: 1rem;
		border-radius: 50%;
		color: white;
		font-weight: 630;
		margin-top: -15px;
		margin-right: -25px;
	}

	.zero-badge {
		display: none;
	}

	.online-dot {
		width: 10px;
		/* Adjust the size as needed */
		height: 10px;
		/* Adjust the size as needed */
		background-color: green;
		border-radius: 50%;
		/* Makes it a circle */
		display: inline-block;
	}

	.online-dot-display{
		display: none;
	}

	.offline-dot-display{
		display: none;
	}

	.offline-dot {
		width: 10px;
		/* Adjust the size as needed */
		height: 10px;
		/* Adjust the size as needed */
		background-color: red;
		border-radius: 50%;
		/* Makes it a circle */
		display: inline-block;
	}

	.friend-container:hover{
		background: #f2f2f2;
	}

	.no-friend{
		display: flex;
		justify-content: center;
		height: 100%;
		{% comment %} border: 2px solid red; {% endcomment %}
		align-items: center;
	}

	.bottom-header{
		position: relative;
		margin-bottom:0.8em;
	}

	.inside_msg_cont{
		
		position:relative;
		padding-right: 4px;
    background: #ff943b;
    min-width: 61px;
    min-height: 37px;
    padding-left: 4px;
    border-radius: 10px;
	max-width:400px;
	}

	.inside_msg_cont p {
		font-weight:500;
		color:white;
	}

	.inside_msg_cont1 p {
		font-weight:500;
	}

	.inside_msg_cont1{
		background: #f0f2f2;
		{% comment %} padding-right: 4px;
		min-width: 90px;
		min-height: 45px;
		padding-left: 4px;
		border-radius: 8px;
		max-width:400px; {% endcomment %}
		max-width:400px;
	position:relative;
	padding-right: 4px;
    background: #e6e6e6;
    min-width: 61px;
    min-height: 37px;
    padding-left: 6px;
    border-radius: 10px;
    font-weight: 500!important;
	}
	.inside_msg_contr{
		background: #d8d8d8;
	position:relative;
	padding-right: 10px;
    
    min-width: 61px;
    min-height: 37px;
    padding-left: 6px;
    border-radius: 10px;
    font-weight: 500;
	padding-left: 0.8em;
	margin-top:3px;
	width:100%;
	}
	.dark_orange{
		background: #f1862d!important;
		color:white;
		padding-left:0.8em!important;
		width:100%;
			

	}

	.inside_msg_cont1::before{
        content: '';
        position: absolute;
        top: 0;
        /* left: -8px; */
		right: -8px;
        height: 9px;
        width: 15px;
		
        /* background-color: red; */
        {% comment %} background: linear-gradient(135deg, #f0f2f2 0%, #f0f2f2 50%, transparent 50%, transparent); {% endcomment %}
        background: linear-gradient(135deg, #e6e6e6 0%, #e6e6e6 50%, transparent 50%, transparent);
        /* background: linear-gradient(226deg, #ebf0f0 0%, #ebf0f0 50%, transparent 50%, transparent); */
    }

	.inside_msg_cont::before{
        content: '';
        position: absolute;
        top: 0;
        left: -8px;
		/* right: -8px; */
        height: 9px;
        width: 15px;
		
        /* background-color: red; */
        {% comment %} background: linear-gradient(226deg, #f0f2f2 0%, #f0f2f2 50%, transparent 50%, transparent); {% endcomment %}
        /* background: linear-gradient(226deg, #ebf0f0 0%, #ebf0f0 50%, transparent 50%, transparent); */

		background: linear-gradient(226deg, #ff943b 0%, #ff943b 50%, transparent 50%, transparent);
    }



	{% comment %} .inside_msg_cont{
		padding-right: 4px;
		background: #f0f2f2;
		min-width: 90px;
		min-height: 45px;
		padding-left: 4px;
		border-radius: 8px;
		max-width:400px;
	}

	.inside_msg_cont1{
		padding-right: 4px;
		background: #f0f2f2;
		min-width: 90px;
		min-height: 45px;
		padding-left: 4px;
		border-radius: 8px;
		max-width:400px;
	}

	.inside_msg_cont1::before{
        content: '';
        position: absolute;
        top: 0;
        /* left: -8px; */
		right: -8px;
        height: 9px;
        width: 15px;
		
        /* background-color: red; */
        background: linear-gradient(135deg, #f0f2f2 0%, #f0f2f2 50%, transparent 50%, transparent);
        /* background: linear-gradient(226deg, #ebf0f0 0%, #ebf0f0 50%, transparent 50%, transparent); */
    }

	.inside_msg_cont::before{
        content: '';
        position: absolute;
        top: 0;
        left: -8px;
		/* right: -8px; */
        height: 9px;
        width: 15px;
		
        /* background-color: red; */
        background: linear-gradient(226deg, #f0f2f2 0%, #f0f2f2 50%, transparent 50%, transparent);
        /* background: linear-gradient(226deg, #ebf0f0 0%, #ebf0f0 50%, transparent 50%, transparent); */
    } {% endcomment %}

	.msg-p{
		font-size: 18px;
		margin-right: 1.5em;
	}

	.top-cont-left{
		align-items: center;
	}

	.typo{
		margin-left: 1em;
		color: green;
		font-size: 16px;
	}

	.msg-c{
		position: absolute;
		bottom: 5px;
		right: 6px;
		/* font-size: 12px; */
	}

	/* Styling the scrollbar track (the non-draggable part) */
::-webkit-scrollbar-track {
    background: none; /* Set the color of the track */ 

}

	.svg-path {
    	/* fill: #FF5733; Change the fill color to your desired color */
	}

	.friends-list-container{
		/* border: 2px solid; */
		max-height: 70svh;
		overflow: scroll;
	}

	.back-arrow{
		display: none;
	}

	.no-selection{
		height: 100%;
		position: absolute;
		border: 1px solid #707070;
		border-radius: 8px;
		background: #f0f0f0;
		z-index: 1;
		width: 100%;
		display: flex;
		justify-content: center;
		align-items: center;
	}

	.contenta{
		/* border: 2px solid green;
		height: 40%;
    	width: 45%; */
	}

	.contenta p {
		font-weight: 900px;
	}

	.friend-container{
		{% comment %} border: 1px solid rgb(52, 58, 64); {% endcomment %}
    border-radius: 8px;
    display: flex !important;
    flex-direction: column !important;
	border: 1px solid rgb(205 205 205);
	}



	@media (max-width: 767px) {
		#myDiv {
		   background-color: #f5f5f5;
	 border: 1px solid #ddd;
	 border-radius: 5px;
	 padding: 6px 15px 16px 15px;
	position: absolute;
	top: -71px;  /* Adjust based on height of div and input field */
	{% comment %} left: 0; {% endcomment %}
	width: 88%;
	z-index: 1;  /* Ensure it overlaps the input field /  / Your mobile styles here */
		}
}
@media (min-width: 767px) {
		#myDiv {
		   background-color: #f5f5f5;
	 border: 1px solid #ddd;
	 border-radius: 5px;
	 padding: 5px;
	position: absolute;
	top: -72px;  /* Adjust based on height of div and input field */
	
	
	display:inline-block;
	z-index: 1;  /* Ensure it overlaps the input field /  / Your mobile styles here */
		}
}





.chat-bubble { 
background-color:#E6F8F1;
padding:16px 28px;
-webkit-border-radius: 20px;
-webkit-border-bottom-left-radius: 2px;
-moz-border-radius: 20px;
-moz-border-radius-bottomleft: 2px;
border-radius: 20px;
border-bottom-left-radius: 2px;
display: block;;

}
.typing {
align-items: center;
display: flex;
height: 30px;


}
.typing .dot {
animation: mercuryTypingAnimation 1.8s infinite ease-in-out;
{% comment %} background-color: #6CAD96 ;  {% endcomment %}
background-color:#e6e6e6;
border-radius: 50%;
height: 7px;
margin-right: 4px;
vertical-align: middle;
width: 7px;
display: inline-block;
}
.typing .dot:nth-child(1) {
animation-delay: 200ms;
}
.typing .dot:nth-child(2) {
animation-delay: 300ms;
}
.typing .dot:nth-child(3) {
animation-delay: 400ms;
}
.typing .dot:last-child {
margin-right: 0;
}

@keyframes mercuryTypingAnimation {
0% {
transform: translateY(0px);
{% comment %} background-color:#6CAD96;  {% endcomment %}
background-color:#f1862d; 
}
28% {
transform: translateY(-7px);
{% comment %} background-color:#9ECAB9;  {% endcomment %}
background-color:#f5bd8f; 
}
44% {
transform: translateY(0px);
{% comment %} background-color: #B5D9CB; {% endcomment %}
background-color: #ff943b;
}
}

@media (max-width: 767px) {
#replytext {
overflow: hidden;
display: -webkit-box;
-webkit-line-clamp: 1; /* Set the number of lines you want to display */
-webkit-box-orient: vertical;
text-overflow: ellipsis;

}  
}


.my-lappy-textoo {
overflow: hidden;
display: -webkit-box;
-webkit-line-clamp: 1; /* Set the number of lines you want to display */
-webkit-box-orient: vertical;
text-overflow: ellipsis;

}  





.truncate-text {
display: -webkit-box;
}


	/* Media query for tablet width 320px */
  @media only screen and (min-width: 300px) and (max-width: 600px) {  
	body{
		height: unset;
	}

	
	

	.timestamp-span.hidden {
		display: none!important;
	}
	
	.msg_cont1_timestamp{
		right: 3px;
		bottom: -14px;
		position: absolute;
		font-size: 10px;
		font-weight: 400;
	}
	
	.msg_cont_timestamp{
		left: 3px;
		bottom: -14px;
		position: absolute;
		font-size: 10px;
		font-weight: 400;
	}
	

	.main-container{
		/* height: 90vh; */
		height: calc(100svh - 113px);
		flex: unset;
	}

	.inside_msg_cont{
		max-width: 260px;
	}

	.inside_msg_cont1{
		max-width: 260px;
	}

	.cont-row{
		position: relative;
		overflow: hidden;
	}

	.left-column{
		width: 99%;
    	height: 99%;
	}

	.right-column{
		position: absolute;
		left: 100%;
		width: 99%;
    	height: 99%;
		margin-left: 0px;
		transition: left 0.5s; 
	}

	.back-arrow{
		display: block;
		margin-right: 2px;	
	}

	#id_other_username{
		font-size: 15px;
	}

	#offline_dot{
		font-size: 15px;
	}

	#online_dot{
		font-size: 15px;
	}

	.video-textarea{
		height: 46px;
	}

	.send-btn{
		font-size: 18px;
		top: 14px;
	}

	.top-cont-left{
		width: 70%;
	}

	.typo{
		margin-left: 1em;
    	font-size: 11px;
	}

	
	.send-btn{
		font-size: 16px;
    top: 7px;
	}

	.video-textarea{
		height: 30px!important;
		border-radius:40px;
		margin-left:0px;
		font-size:13px;
	}

	.video-textarea{
		height: 46px;
	}

	

	.bottom-header{
		margin-bottom:15px;
	}

@media (max-width: 767px) {
            #myDiv {
               background-color: #f5f5f5;
		 border: 1px solid #ddd;
		 border-radius: 10px!important;
		 padding: 5px;
		position: absolute;
		top: -72px;  /* Adjust based on height of div and input field */
		{% comment %} left: 0; {% endcomment %}
		width: 88%;
		z-index: 1;  /* Ensure it overlaps the input field /  / Your mobile styles here */
            }
  }
@media (min-width: 767px) {
            #myDiv {
               background-color: #f5f5f5;
		 border: 1px solid #ddd;
		 border-radius: 5px;
		 padding: 5px;
		 position: absolute;
		 bottom: 3em;
		top: -72px;  /* Adjust based on height of div and input field */
		left: 0;
		
		display:inline-block;
		z-index: 1;  /* Ensure it overlaps the input field /  / Your mobile styles here */
            }
  }

  @media (max-width: 767px) {
	#replytext {
	  overflow: hidden;
	  display: -webkit-box;
	  -webkit-line-clamp: 1; /* Set the number of lines you want to display */
	  -webkit-box-orient: vertical;
	  text-overflow: ellipsis;
	  
	}  
	 }
	
	
	.my-lappy-textoo {
	  overflow: hidden;
	  display: -webkit-box;
	  -webkit-line-clamp: 1; /* Set the number of lines you want to display */
	  -webkit-box-orient: vertical;
	  text-overflow: ellipsis;
	  
	}  
	
	
	
	
	
	.truncate-text {
	  display: -webkit-box;
	}

	.typing {
		align-items: center;
		display: flex;
		height: 30px;
		
		
	  }
	  .typing .dot {
		animation: mercuryTypingAnimation 1.8s infinite ease-in-out;
		{% comment %} background-color: #6CAD96 ;  {% endcomment %}
		background-color:#e6e6e6;
		border-radius: 50%;
		height: 7px;
		margin-right: 4px;
		vertical-align: middle;
		width: 7px;
		display: inline-block;
	  }
	  .typing .dot:nth-child(1) {
		animation-delay: 200ms;
	  }
	  .typing .dot:nth-child(2) {
		animation-delay: 300ms;
	  }
	  .typing .dot:nth-child(3) {
		animation-delay: 400ms;
	  }
	  .typing .dot:last-child {
		margin-right: 0;
	  }
	  
	  @keyframes mercuryTypingAnimation {
		0% {
		  transform: translateY(0px);
		  {% comment %} background-color:#6CAD96;  {% endcomment %}
		  background-color:#f1862d; 
		}
		28% {
		  transform: translateY(-7px);
		  {% comment %} background-color:#9ECAB9;  {% endcomment %}
		  background-color:#f5bd8f; 
		}
		44% {
		  transform: translateY(0px);
		  {% comment %} background-color: #B5D9CB; {% endcomment %}
		  background-color: #ff943b;
	    }
	  }
	}

</style>



<div class="main-container">
	<div class="row cont-row">
		
		<div class="left-column video">
			
			<button id="notif-btn" style='dispaly:block; color: #009cad;
			border: 1px solid #313131;
			dispaly: block;
			font-size: 14px;
			background: transparent;
			padding: 4px;
			border-radius: 21px;' onclick="SubscribeUser()">Click here to turn on the notifications</button>
    <h6 class="" id =""></h6>
			<div class="card left-card">
				<div class="d-flex flex-row align-items-center card-header">
					<h3>Friends</h3>
				</div>
				<div class="card-body p-1">
					<div class="d-flex flex-column friends-list-container ">
						{% if m_and_f %}
						{% for x in m_and_f %}
						<div class="d-flex flex-row p-2 friend-container flex-grow-1 mt-1 mb-1"
							onclick="onSelectFriend('{{x.friend.id}}')" id="id_friend_container_{{x.friend.id}}">
							{% comment %} <img class="profile-image rounded-circle img-fluid"
								id="id_friend_img_{{x.friend.id}}" src="{% static 'codingwithmitch/dummy_image.png' %}">
							{% endcomment %}
							<div class="d-flex flex-row friends">
								<span style="display: flex; flex-direction:column;">
								<span class="username-span">{{x.friend.name}}</span>
								<span class="text-secondary" style="font-size:10px; margin-left:5px;">Active {{x.friend.last_activity|naturaltime}}</span></span>
								{% if x.unread_messages_count != 0 %}
								<span class="friend-message-span notify-badge"
									id="id_friend_count_{{x.friend.id}}">{{x.unread_messages_count}}</span>
								{% else %}
								<span class="friend-message-span notify-badge zero-badge"
									id="id_friend_count_{{x.friend.id}}">{{x.unread_messages_count}}</span>

								{% endif %}
							</div>
							<p style="
								margin-bottom: 0px;
								padding-left: 0.5em;
							">
						
							{% comment %} {% if x.last_message|length > 30 %}
                               
							{{ x.last_message|slice:":30" }}...
                                    
                                
                            {% elif x.last_message == 'None'%}
                                 
							{% else %}
								{{x.last_message}}
                            {% endif %} {% endcomment %}
						
						</p>
						</div>
						{% endfor %}
						{% else %}
						<span class="username-span">You don't Have any friends </span>
						{% endif %}
					</div>
				</div>
			</div>
		</div>
		<div class="right-column">
			
			<div class="card" id="id_chatroom_card">
				{% if m_and_f %}
				<!-- Right column content goes here -->
				<div class="right-header" id="id_room_title">
					<div class="d-flex top-cont-left">
						<div class="back-arrow" id="bk-arrow" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></div>
					<a class="d-flex flex-column" id="id_user_info_container">
						<h4 class="ml-2" id="id_other_username"></h4>
						<span class="text-secondary ml-2" id="last_seen" style="font-size:10px;"></span>
					</a>
					
				</div>
					<div id='online_dot' class="online-dot-display"><span class="online-dot">
						</span><span style="
						margin-right: 10px;
						padding-left: 5px;
					"></span>
					</div>

					<div id='offline_dot' class="offline-dot-display"><span class="offline-dot">
						</span><span style="
						margin-right: 10px;
						padding-left: 5px;
					"></span>
					</div>
				</div>
				<div class="d-flex flex-row justify-content-center" id="id_chatroom_loading_spinner_container">
					<div class="spinner-border text-primary" id="id_chatroom_loading_spinner" role="status"
						style="display: none; position: absolute; ">
						{% comment %} <span class="sr-only">Loading...</span> {% endcomment %}
					</div>
				</div>
				<div class="d-flex flex-column" id="id_chat_log_container">
					{% comment %} <div class="no-selection">
						<div class="contenta"><p>Click on the friend whith whom you wanna chat</p></div>
					</div> {% endcomment %}
					
						<div class="d-flex chat-log" id="id_chat_log">

						</div>
						<span class="{% if not debug %}d-none{% endif %} page-number" id="id_page_number">1</span>
						<div class="bottom-header">
							{% comment %} <button class="btn btn-dark skip-btn" id="skip_button">
								<span id="skip">Skip</span>
							</button>
							<a href="{% url 'new-chat' %}"><button class="btn btn-dark skip-btn d-none" id="new_button">
									<span id="new">New</span>
								</button></a> {% endcomment %}
							<!-- <textarea disabled class="flex-grow-1 chat-message-input"
									id="id_chat_message_input"></textarea> -->
									<div style="transform: translateX(-30px); width:30px; ">
										<div id="typing" class="typing d-none">
									<div class="dot"></div>
									<div class="dot"></div>
									<div class="dot"></div>
									</div>
									</div>
												<div class="txtarea-cont">
			
													<textarea class="flex-grow-1 video-textarea" id="id_chat_message_input" placeholder="say something..."></textarea>
													<button class="chat-message-submit-button send-button send-btn-cont" id="send_button">
														<span id="id_chat_message_submit" class="material-icons send-btn">send
														</span>
													</button>
												</div>
									</div>
						</div>
					
				</div>
				{% else %}
				<div class="no-friend">
					<span>You don't Have any messages buddy</span>
				</div>
				{% endif %}
			</div>
			
		</div>
	</div>
</div>








<!-- Client Error MODAL -->
<button type="button" id="id_trigger_client_error_modal" class="d-none btn btn-primary" data-toggle="modal"
	data-target="#id_client_error_modal">
</button>
<div class="modal fade" id="id_client_error_modal" tabindex="-1" role="dialog">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Socket Client Error</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<p id="id_client_error_modal_body">Something went wrong.</p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal"
					id="id_client_error_modal_close_btn">Close</button>
			</div>
		</div>
	</div>
</div>
<!-- Client Error MODAL -->
{% comment %} <script>
	/* Load the Bitmoji Kit SDK asynchronously */
	(function (d, s, id) {
	  var js, sjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "https://sdk.snapkit.com/js/v1/login_bitmoji.js";
	  sjs.parentNode.insertBefore(js, sjs);
	}(document, 'script', 'bitmojikit-sdk'));
  </script>
<script src="{% static 'collections/collections.min.js' %}"></script> {% endcomment %}
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>
<script>

	

	if (Notification.permission === "granted") {
		{% if token_exist == 'yes' %}
			// Notifications are enabled
			console.log('the notifications are enabled!')
			var nbtn = document.getElementById('notif-btn')
			nbtn.style.display = 'none'
		{% endif %}
		
	  } else if (Notification.permission === "denied") {
		// Notifications are disabled
		console.log('notif arre not enable permission denied!')
	  } else {
		// Notifications permission is not set, you can ask for permission
		console.log('notif are not enabled at all')
	  }
	  

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>


<script type="text/javascript">
{% comment %} /* Setup Bitmoji Kit Web here */
window.snapKitInit = () => {
	const bitmojiWebPickerIconClass = "bitmojiStickerPicker";
	const uiOptions = {
	  onStickerPickCallback: sendImage,
	  webpickerPosition: "topLeft",
	};
	const loginParamsObj = {
	  clientId: /* your client id here: */ "",
	  redirectURI: "http://localhost:8081/",
	  scopeList: [
		 "user.bitmoji.avatar",
		 "user.display_name",
	  ]
	};
	
  snap.bitmojikit.mountBitmojiStickerPickerIcons(
	  bitmojiWebPickerIconClass,
	  uiOptions,
	  loginParamsObj
	);
  } {% endcomment %}

	{% comment %} var generalCachedMsgNotifList = new List([]) {% endcomment %}

	// submitGeneralMsgNotificationToCache()
	{% comment %} console.log(generalCachedMsgNotifList) {% endcomment %}

	
	function goBack(){
		var rightColumn = document.querySelector('.right-column');
		rightColumn.style.left = '100%';
	}

	function submitGeneralMsgNotificationToCache() {
		// console.log('SGNMTOCAHE is being called')

		friends_dict = {}


		{% if m_and_f %}

		// console.log("{{m_and_f}}")
		{% for item in m_and_f %}
		//console.log("{{item.friend.id}}")
		friends_dict["{{item.friend.name}}"] = "{{item.friend.id}}"


		{% endfor %}

		// console.log(friends_dict)

		{% endif %}

		return friends_dict

	}


	function startMsgNotificationService() {
		if ("{{request.user.is_authenticated}}" == "True") {
			setInterval(request_unread_msg_count, 4000)
		}
	}


	function request_unread_msg_count() {
		// Start the fun
		if ("{{request.user.is_authenticated}}") {
			chatNotifSocket.send(JSON.stringify({
				"command": "start",
				"friends_dict": submitGeneralMsgNotificationToCache(),
			}));
		}
	}

	function updateUnreadGeneralNotificationsCount(id_count_dict) {

		// console.log("i am getting called")

		{% comment %} {% for key, value in id_count_dict.items %}
		var countElement = document.getElementById("id_friend_count_{{key}}")
		countElement.innerHTML = {{ value }}
	}
	countElement.style.background = "red"
	countElement.style.display = "block"
	// console.log("changed the ", key, "by ", value)
	{% endfor %} {% endcomment %}

	for (var key in id_count_dict) {
		if (id_count_dict.hasOwnProperty(key)) {
			var value = id_count_dict[key];
			// console.log("Key: " + key + ", Value: " + value);
			if (value != 0) {
				var countSpan = document.getElementById("id_friend_count_" + key)
				countSpan.innerHTML = value
				countSpan.style.background = "red"
				countSpan.style.cssText = "display: block !important;";
			} else{
				var countSpan = document.getElementById("id_friend_count_" + key)
				countSpan.innerHTML = value
				countSpan.style.background = "transparent"
				countSpan.style.cssText = "display: none !important;";
			}

		}
	}
			
	}




	var chatSocket = null;
	var roomId = null;
	var room_name = null;
	var auth_user_id = {{id}};

	{% if not request.user_agent.is_mobile %}
	onStart()

	function onStart() {
		{% if room %}
	 	if ("{{room.user1}}" == "{{request.user}}") {
	 		onSelectFriend("{{room.user2.id}}")
	 	}
	 	else {
	 		onSelectFriend("{{room.user1.id}}")
	 	}
	 	{% else %}
	 	{% if m_and_f %}
	 	onSelectFriend("{{m_and_f.0.friend.id}}")
	 	{% endif %}
	 	{% endif %}
	 }
	{% endif %}

	function onSelectFriend(userId) {
		
		createOrReturnPrivateChat(userId)
		clearHighlightedFriend()
		highlightFriend(userId)
		updatePhone()
	}

	function updatePhone(){
		var rightColumn = document.querySelector('.right-column');
		rightColumn.style.left = '0%';
	}

	function closeWebSocket() {
		if (chatSocket != null) {
			chatSocket.close()
			chatSocket = null
			// leaveCount = 0;
			clearChatLog()
			setPageNumber("1")
			disableChatLogScrollListener()
		}

	}

	function setupWebSocket(room_id) {


		console.log("setupWebSocket: " + room_id)

		roomId = room_id
		


		// close previous socket if one is open
		closeWebSocket()

		// Correctly decide between ws:// and wss://
		
		var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
		var ws_path = ws_scheme + '://' + window.location.host + "/mchat/" + roomId + "/"; 
		{% comment %} var ws_path = ws_scheme + '://' + window.location.host + ":8001/mchat/" + roomId + "/"; // production {% endcomment %}


		// console.log("Connecting to " + ws_path);
		chatSocket = new WebSocket(ws_path);

		// let leaveCount = 0;

		// Handle incoming messages
		chatSocket.onmessage = function (message) {
			// Decode the JSON
			console.log("Got chat websocket message " + message.data);
			console.log("Got websocket message.");
			var data = JSON.parse(message.data);

			// display the progress bar?
			displayChatroomLoadingSpinner(data.display_progress_bar)

			// Handle errors (ClientError)
			if (data.error) {
				console.error(data.error + ": " + data.message)
				showClientErrorModal(data.message)

			}
			// Handle joining (Client perspective)
			if (data.join) {
				console.log("Joining room " + data.join);
				room_name = data.room_name
				console.log("The group name is -",room_name)
				getUserInfo()
				getRoomChatMessages()
				enableChatLogScrollListener()
				markRoomCount()
				console.log("*************** The room id is - ",data.room_id)
				startStatusCheckService()

				var lastSeenElement = document.getElementById('last_seen'); // Correct variable name

				var lastSeenJson = data.last_seen;
				console.log('bc ', lastSeenJson);

				// Parse the JSON string
				var lastSeenTimestamp = JSON.parse(lastSeenJson);
				console.log('bc ', lastSeenTimestamp);

				// Assuming lastSeenTimestamp is a Unix timestamp (in seconds)
				var lastSeenMoment = moment(lastSeenTimestamp);

				// Format the last seen time using moment.js
				var formattedLastSeen = lastSeenMoment.fromNow();

				// Update the HTML element with the formatted last seen time
				lastSeenElement.innerHTML = 'last seen ' + formattedLastSeen;
								

			}

			// user info coming in from backend
			if (data.user_info) {
				handleUserInfoPayload(data.user_info)
				window.friend_name = data.user_info.name
				console.error('Got the name - ', window.friend_name)

			}

			// Handle leaving (client perspective)
			if (data.leave) {
				// do nothing
				console.log("Leaving room " + data.leave);
			}

			if (data.status_check){
				// count++;
				console.log('This is going to check the status every 10 secs ')
				if (data.status == "online"){
					console.log("it's the online status")
					var offline_dot = document.getElementById('offline_dot')
					offline_dot.style.display = 'none';

					var online_dot = document.getElementById('online_dot')
					online_dot.style.display = 'inline-block';

					var last_seen = document.getElementById('last_seen')
					last_seen.style.display='none'


					// var pathElements = document.querySelectorAll('.svg-path')
					// pathElements.forEach(function(pathElement) {
					// 	console.log("*_----------- updating the color of each element")
					// 	pathElement.style.fill = "#009cda"; // Change the fill color to your desired color
					// });

				} else {
					// leaveCount++;
					// if (leaveCount == 1){
						console.log('its the offline status')
						// console.log('The leave count is - ', leaveCount)
						var online_dot = document.getElementById('online_dot')
						online_dot.style.display = 'none';
						
						var offline_dot = document.getElementById('offline_dot')
						offline_dot.style.display = 'inline-block';
					// } else{
						// console.log("This is the second time of leave message so we will ignore it", leaveCount)
					// }
				}


			}

			// Handle getting a message
			if (data.msg_type == 0 || data.msg_type == 1 || data.msg_type == 2) {
				console.log(data)
				console.log("The authenticated user id is - ", auth_user_id,data)

				appendChatMessage(data, false, true, auth_user_id,data.read)
					
			}

			if (data.msg_type == 1 || data.msg_type == 2){
				if (data.status == "online"){
					console.log("it's the online status")
					var offline_dot = document.getElementById('offline_dot')
					offline_dot.style.display = 'none';

					var online_dot = document.getElementById('online_dot')
					online_dot.style.display = 'inline-block';

					var last_seen = document.getElementById('last_seen')
					last_seen.style.display='none'

					var pathElements = document.querySelectorAll('.svg-path')
					pathElements.forEach(function(pathElement) {
						console.log("*_----------- updating the color of each element")
						pathElement.style.fill = "#009cda"; // Change the fill color to your desired color
					});

				} else {
					// leaveCount++;
					// if (leaveCount == 1){
						console.log('its the offline status')
						// console.log('The leave count is - ', leaveCount)
						var online_dot = document.getElementById('online_dot')
						online_dot.style.display = 'none';
						
						var offline_dot = document.getElementById('offline_dot')
						offline_dot.style.display = 'inline-block';
					// } else{
						// console.log("This is the second time of leave message so we will ignore it", leaveCount)
					// }
				}

			}



if (data.isTyping) {

    if (data.id != auth_user_id) {

        const typingIndicator = document.getElementById('typing');

        if (typingIndicator.classList.contains("d-none")) {
            console.error("removed d-none");
            typingIndicator.classList.remove("d-none");

            // Add a timeout to remove the message after 2 seconds (adjust as needed)
            setTimeout(() => {
                typingIndicator.classList.add("d-none");
            }, 2000);
        } else {
            // Reset the timeout if the user is still typing
            clearTimeout(typingIndicator.timeoutId);
            typingIndicator.timeoutId = setTimeout(() => {
                typingIndicator.classList.add("d-none");
            }, 2000); // Remove the message after 2 seconds (adjust as needed)
        }
    }
}



			if(data.message_deleted){
				console.log('message deleted called - ', 'msgdiv-' + data.msg_id)
				var element = document.getElementById('msgdiv-'+data.msg_id)
				if (element){
					console.log('sup boi - ')
					element.classList.remove('d-flex')
					element.classList.add('d-none')
					element.style.display='none !important';
				}
			}

			// new payload of messages coming in from backend
			if (data.messages_payload) {
				// console.log(data.messages)
				handleMessagesPayload(data.messages, data.new_page_number)
			}

			if (data.marked) {
				setMsgNotificationsAsRead()
			}

		};

		chatSocket.addEventListener("open", function (e) {
			console.log("ChatSocket OPEN")
			// join chat room
			if ("{{request.user.is_authenticated}}") {
				chatSocket.send(JSON.stringify({
					"command": "join",
					"room": roomId
				}));
			}
		})

		chatSocket.onclose = function (e) {
			console.log('Chat socket closed.');
		};

		chatSocket.onOpen = function (e) {
			console.log("ChatSocket onOpen", e)
		}

		chatSocket.onerror = function (e) {
			console.log('ChatSocket error', e)
		}

		if (chatSocket.readyState == WebSocket.OPEN) {
			console.log("ChatSocket OPEN")
		} else if (chatSocket.readyState == WebSocket.CONNECTING) {
			console.log("ChatSocket connecting..")
		}
	}


	// document.getElementById('id_chat_message_input').focus();
	document.getElementById('id_chat_message_input').onkeyup = function (e) {
		if (e.keyCode === 13 && e.shiftKey) {  // enter + return
			// Handled automatically by textarea
		}
		else if (e.keyCode === 13 && !e.shiftKey) { // enter + !return
			document.getElementById('id_chat_message_submit').click();
		}
	};

	

	document.getElementById('id_chat_message_submit').onclick = function (e) {
		const messageInputDom = document.getElementById('id_chat_message_input');
		
		var rep_msg = document.getElementById('replytext');
		var rep_name = document.getElementById('replyme');
		{% comment %} console.error('the jhkw ', window.textoo.innerHTML,window.textr.innerHTML); {% endcomment %}
		if(rep_msg || rep_name){
			window.rep_msg =  window.textoo.innerHTML;
			window.rep_name = window.textr.innerHTML;
		} else {
			window.rep_msg = null;
			window.rep_name = null;
		}
		const message = messageInputDom.value;

		console.error('this is the rep_id ', window.rep_id)
		
		

		if ($('#myDiv').length) {
			console.log("Element with ID 'myDiv' exists. Removing...");
			$('#myDiv').remove();
		} else {
			console.log("Element with ID 'myDiv' does not exist.");
		}
		
		if(window.rep_id){
			console.log('we have a reply - ',window.rep_id)
		}else{
			console.log('no rep - ', window.rep_id)
			window.rep_id = null
		}
		
		chatSocket.send(JSON.stringify({
			"command": "send",
			"message": message,
			"rep_msg": window.rep_msg,
			'rep_name': window.rep_name,
			'rep_id': window.rep_id,
			"room": roomId
		}));
		messageInputDom.value = '';
	};

	// typing setup -----



    const inputField = document.getElementById('id_chat_message_input');
    inputField.addEventListener('input', (event) => {

		// Check if the Enter key is pressed
if (event.inputType === 'insertParagraph' && event.data === '\n') {
    console.error('Enter key pressed');
    return;
}

    // Check if the input type is 'deleteContentBackward' (backspace) or 'insertParagraph' (enter)
    if (event.inputType == 'deleteContentBackward' || event.inputType == 'insertLineBreak' || event.data == null || event.data == 'null') {
        console.error('no typing');
        return;
    } 
	
		

		// console.log('The onchange function is getting called')
        // Send a "typing" event to the server using WebSocket
		if (room_name != null){
			// console.log("----- The group name is - ", room_name)
			chatSocket.send(JSON.stringify(
				{
					"command": "typing",
					"group_name": room_name,
					"isTyping": true,
					// "userName": window.self_name, // Add the username
					"userId": auth_user_id, // Add the user's ID 
				}
			));
	}
    });

	function startStatusCheckService() {
		// if ("{{request.user.is_authenticated}}" == "True") {
			console.log('The 4sec interval has been set')
			setInterval(statusCheck, 10000)
		// }
	}

	// This function is going to check every 3-5 secs that whether the user is online or not
	function statusCheck(){
		// count++;
		// console.log("sending status check command to the backend - ", count)
		chatSocket.send(JSON.stringify({
			"command": "status_check",
			// "room": roomId
		}));
	}

	function selectUser(user_id) {
		// Weird work-around for passing arg to url
		var url = "{% url 'account:view' user_id=243823983752487823 %}".replace("243823983752487823", user_id)
		var win = window.open(url, "_blank")
		win.focus()
	}

	function getUserInfo() {
		chatSocket.send(JSON.stringify({
			"command": "get_user_info",
			"room_id": roomId,
		}));
	}
	function markRoomCount() {
		chatSocket.send(JSON.stringify({
			"command": "mark_room_read",
			"room_id": roomId,
		}));
	}

	// function mark_room_read(){
	// 	chatSocket.send(JSON.stringify({
	// 		"command": "mark_room_read",
	// 		"roomId": roomId,
	// 	}));
	// }

	function setMsgNotificationsAsRead() {
		var countElement = document.getElementById("id_msg_notifications_count")
		countElement.style.background = "transparent"
		countElement.style.display = "none"
		getUnreadMessageNotificationsCount()
	}

	function handleUserInfoPayload(user_info) {
		
		document.getElementById("id_other_username").innerHTML = user_info['name'] + ' | ' + user_info['uniName'].slice(0,12) + '...' 
		console.log("other user is "+user_info['name']);
		document.getElementById("id_user_info_container").href = "{% url 'account:view' user_id=4586463456756486676 %}".replace("4586463456756486676", user_info['id'])


	}

	function showClientErrorModal(message) {
		document.getElementById("id_client_error_modal_body").innerHTML = message
		document.getElementById("id_trigger_client_error_modal").click()
	}

	function appendChatMessage(data, maintainPosition, isNewMessage, auth_user_id,read) {
		messageType = data['msg_type']
		msg_id = data['msg_id']
		message = data['message']
		uName = data['name']
		user_id = data['user_id']
		uniName = data['uniName']
		timestamp = data['natural_timestamp']
		readMsg = data['read']
		reply_msg = data['reply_msg']
		reply_name = data['reply_name']
		reply_id = data['reply_id']
		if(reply_msg){
		console.error("You see your friend replied to: "+reply_name);
		console.error("You see your friend replied:  "+reply_msg);
		
		}

		// console.log("append chat message: " + messageType)

		// username = uName + " | " + uniName + " :"
		username = uName + " :"
		msg = message + '\n'
		// determine what type of msg it is
		switch (messageType) {
			case 0:
				// new chatroom msg
				username = uName + ": "
				msg = message + '\n'
				if (read == null){
					
					createChatMessageElement(msg, msg_id, username, uniName, user_id, timestamp, maintainPosition, isNewMessage, auth_user_id,readMsg,reply_msg,reply_name,reply_id) 
				} else if (read == true || read == false || read == 'True' || read == "False"){
					createChatMessageElement(msg, msg_id, username, uniName, user_id, timestamp, maintainPosition, isNewMessage, auth_user_id,read,reply_msg,reply_name,reply_id) 
				}
				break;
			case 1:
				// User joined room
				// createConnectedDisconnectedElement(message, msg_id, uniName, user_id)
				break;
			case 2:
				// User left room
				// createConnectedDisconnectedElement(message, msg_id, uniName, user_id)
				break;
			default:
				console.log("Unsupported message type!");
				return;
		}
	}

	/*
		Build a new ChatMessage element and append to the list
	*/
	function createChatMessageElement(msg, msg_id, username, uniName, user_id, timestamp, maintainPosition, isNewMessage,auth_user_id,read,reply_msg,reply_name,reply_id) {

		// console.log("***************************************************************************************************************************************************************************************** The value of read is - ",read)
		var reply_message = reply_msg
		if (reply_message && reply_message.length > 100) {
  // Trim the string to 300 characters and add trailing dots
  var truncatedreply = reply_message.substring(0, 100) + "...";
  
  // Use the truncatedString as needed
  console.log('yess its biggg',truncatedreply);
	window.reply_msg=truncatedreply
	reply_msg = truncatedreply
} else {
  // If the string is already 300 characters or less, use the original string
  console.log('lillllyyyy ',reply_message);
		window.reply_msg=reply_msg
	
}
		console.error('this is the rep_msg and rep_name',reply_msg,reply_name,reply_id)
		var chatLog = document.getElementById("id_chat_log")

		var newMessageDiv = document.createElement("div")
		newMessageDiv.classList.add("d-flex")
		newMessageDiv.classList.add("flex-row")
		newMessageDiv.id = "msgdiv-"+msg_id;
		
		if (auth_user_id == user_id){
			// console.log('The user_id',user_id)
			// console.log('The auth_user_id',auth_user_id)
			newMessageDiv.classList.add("message-container1")
		} else{
			newMessageDiv.classList.add("message-container")
			
			// console.log('The user_id',user_id)
			// console.log('The auth_user_id',auth_user_id)
		}

		{% comment %} var profileImage = document.createElement("img")
		profileImage.addEventListener("click", function (e) {
			selectUser(user_id)
		})
		profileImage.classList.add("profile-image")
		profileImage.classList.add("rounded-circle")
		profileImage.classList.add("img-fluid")
		profileImage.src = "{% static 'codingwithmitch/dummy_image.png' %}"
		var profile_image_id = "id_profile_image_" + msg_id
		profileImage.id = profile_image_id
		newMessageDiv.appendChild(profileImage) {% endcomment %}

		var div1 = document.createElement("div")
		div1.classList.add("d-flex")
		div1.classList.add("flex-column")
		if (auth_user_id == user_id){
			div1.classList.add("inside_msg_cont1");
			
			//starts
			// Make the element draggable with touch events

			if (auth_user_id == user_id){
				div1.classList.add("inside_msg_cont1");
			
				// ... your other code ...
			
				// Apply draggable to the newly added element
				$(div1).draggable({
					axis: 'x',
					containment: '.message-container1',
					revert: true,
					stop: function (event, ui) {
						var left = ui.position.left;
						var width = $(this).width();
						var parentWidth = $(this).parent().width();
						if (left < -width / 5) {
							var messageText = $(this).find('.msg-p').text().trim();
							var messageId = $(this).closest('.message-container1').attr('id');
							replyFunction(messageId.replace("msgdiv-", ""), "You");
						}
					}
				});
			}
			
			
			
			
						//ends
			

			

		} else{
			div1.classList.add("inside_msg_cont")
			
			

			$(div1).draggable({
				axis: 'x',
				containment: '.message-container',
				revert: true,
				stop: function (event, ui) {
					// Get the current position of the element
					var left = ui.position.left;
					// Get the width of the element using $(this)
					var width = $(this).width();
					// Get the width of the parent element
					var parentWidth = $(this).parent().width();
					// Check if the element is dragged more than half of its width to the right
					if (left > width / 5) {
						// Call the function you want
						var messageText = $(this).find('.msg-p').text().trim();
						var messageId = $(this).closest('.message-container').attr('id');
						replyFunction(messageId.replace("msgdiv-", ""),window.friend_name);
			        }
			    }
			});
		}
		

		var div2 = document.createElement("div")
		div2.classList.add("d-flex")
		div2.classList.add("flex-row")

		var timestampSpan = document.createElement("span");
		timestampSpan.innerHTML = timestamp;
		timestampSpan.classList.add("timestamp-span");
		timestampSpan.classList.add("d-flex");
		timestampSpan.classList.add("align-items-center");
		timestampSpan.classList.add("text-secondary");
		timestampSpan.classList.add("hidden"); // Apply the hidden class by default
		if (auth_user_id == user_id){
			timestampSpan.classList.add("msg_cont1_timestamp");
		} else {
			timestampSpan.classList.add("msg_cont_timestamp");

			

		}

		if (auth_user_id == user_id){
		var msgbarContainer = document.createElement("div");
		

		msgbarContainer.classList.add("timestamp-span");
		
		msgbarContainer.classList.add("hidden");
			msgbarContainer.classList.add("msg_bar1_timestamp");
	

		
		var toggleButton = document.createElement("a");
		
		{% comment %} toggleButton.innerHTML = '<i class="fa-solid fa-trash" style="color: #ff943b;"></i>'; {% endcomment %}
		toggleButton.innerHTML = '<span style="color:#009cda;">unsend</span>';

		toggleButton.addEventListener("click", function () {
			// Toggle the visibility by adding/removing a CSS class to the timestampContainer
			{% comment %} timestampContainer.classList.toggle("hidden"); {% endcomment %}
			// Call your JavaScript function here
			yourFunction(msg_id);
		});
	}

		 
		


		// Add a click event listener to toggle the visibility of the timestamp
		newMessageDiv.addEventListener("click", function () {
			// Toggle the visibility by adding/removing a CSS class to the timestampSpan
			timestampSpan.classList.toggle("hidden");
			msgbarContainer.classList.toggle("hidden"); 
			
			
		});
		
		div2.appendChild(timestampSpan);
		
		if (auth_user_id == user_id){
		
		msgbarContainer.appendChild(toggleButton);
		
		
if(reply_name=='None' || reply_name==null || reply_name=='null')
			{ console.log('nope not a reply -----------------------------------------------------------')
			}else{


		var replybarContainer = document.createElement("div");
		replybarContainer.classList.add("inside_msg_contr");
		

		if(window.reply_msg){
		if(reply_name=="yourself"){
				reply_name="You";
			}
		replybarContainer.appendChild(document.createTextNode(reply_name));
		replybarContainer.appendChild(document.createElement("br"));
		replybarContainer.appendChild(document.createTextNode(reply_msg));
		 // Add click event listener
		 replybarContainer.addEventListener("click", function() {
			// Your click event handling logic here
			
			var targetElement = document.getElementById("msgdiv-"+reply_id);
			console.error('replybarContainer clicked!','msgdiv-'+reply_id,targetElement);
			
        
			if (targetElement) {
				// Change background color to grey
				targetElement.style.backgroundColor = 'grey';
				targetElement.scrollIntoView({
					behavior: "smooth",
				});

				 // Restore the background color to transparent after 2 seconds with a transition
				 setTimeout(function() {
					targetElement.style.transition = 'background-color 2s ease';
					targetElement.style.backgroundColor = 'transparent';
				}, 0); // Using a small timeout to ensure that the transition property is applied after the initial style change
			

			}

		}); 

		
		}
		div2.appendChild(replybarContainer); }
		
			div2.appendChild(msgbarContainer);
		 }
		else{


			var msgbarContainer = document.createElement("div");
			
			div2.appendChild(msgbarContainer); 

			if(reply_name=='None' || reply_name==null || reply_name=='null')
			{
				console.log('not a reply')
				} else {
			

			
			
			var replybarContainer = document.createElement("div");
		replybarContainer.classList.add("inside_msg_contr");
		if(window.reply_msg){
			if(reply_name=="You"){    
				reply_name= window.friend_name;
			} else{
				reply_name = 'You'
			}
		replybarContainer.appendChild(document.createTextNode(reply_name));
		replybarContainer.appendChild(document.createElement("br"));
		replybarContainer.appendChild(document.createTextNode(reply_msg));
		replybarContainer.classList.add("dark_orange");
		  // Add click event listener
		  replybarContainer.addEventListener("click", function() {
			// Your click event handling logic here
			
			var targetElement = document.getElementById("msgdiv-"+reply_id);
			console.error('replybarContainer clicked!','msgdiv-'+reply_id,targetElement);
			
        
			if (targetElement) {
				// Change background color to grey
				targetElement.style.backgroundColor = 'grey';
				targetElement.scrollIntoView({
					behavior: "smooth",
				});

				 // Restore the background color to transparent after 2 seconds with a transition
				 setTimeout(function() {
					targetElement.style.transition = 'background-color 2s ease';
					targetElement.style.backgroundColor = 'transparent';
				}, 0); // Using a small timeout to ensure that the transition property is applied after the initial style change
			

			}

		}); 
		}
		
		div2.appendChild(replybarContainer);  
	
	}


			div2.appendChild(msgbarContainer);
		}

		
		
		div1.appendChild(div2);


		// var usernameSpan = document.createElement("span")
		// usernameSpan.innerHTML = username
		// usernameSpan.classList.add("username-span")
		// usernameSpan.addEventListener("click", function (e) {
		// 	selectUser(user_id)
		// })
		// div2.appendChild(usernameSpan)

		// var timestampSpan = document.createElement("span")
		// timestampSpan.innerHTML = timestamp
		// timestampSpan.classList.add("timestamp-span")
		// timestampSpan.classList.add("d-flex")
		// timestampSpan.classList.add("align-items-center")
		// timestampSpan.addEventListener("click", function (e) {
		// 	selectUser(user_id)
		// })
		// div2.appendChild(timestampSpan)

		// div1.appendChild(div2)

		var msgP = document.createElement("p")
		msgP.innerHTML = validateText(msg)
		msgP.classList.add("msg-p")
		div1.appendChild(msgP)
		
		if (auth_user_id == user_id){
			
			var msgcheck = document.createElement("span")
			msgcheck.classList.add("msg-c")

			// Create an HTML element with your SVG content
			if (read == true || read == 'True'){
				// console.log("The color is going to be ******************************************************************************************************************************************************************************************************************   BBBBLLUUUUEEEEE" )
				var svgHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" id="double-check"><path class="svg-path" fill="#009cda" fill-rule="evenodd" d="M16.5303 6.46967C16.8232 6.76256 16.8232 7.23744 16.5303 7.53033L6.53033 17.5303C6.38968 17.671 6.19891 17.75 6 17.75 5.80109 17.75 5.61032 17.671 5.46967 17.5303L1.46967 13.5303C1.17678 13.2374 1.17678 12.7626 1.46967 12.4697 1.76256 12.1768 2.23744 12.1768 2.53033 12.4697L6 15.9393 15.4697 6.46967C15.7626 6.17678 16.2374 6.17678 16.5303 6.46967zM22.5303 6.46966C22.8232 6.76254 22.8232 7.23742 22.5303 7.53032L12.5308 17.5303C12.2379 17.8232 11.7631 17.8232 11.4702 17.5304L9.96975 16.0304C9.67681 15.7376 9.67674 15.2627 9.96959 14.9697 10.2624 14.6768 10.7373 14.6767 11.0303 14.9696L12.0004 15.9394 21.4697 6.46968C21.7625 6.17678 22.2374 6.17677 22.5303 6.46966z" clip-rule="evenodd"></path></svg>';
			}else if (read == false || read == 'False'){
				// console.log("The color is going to be ******************************************************************************************************************************************************************************************************************   BBBBLLAACCKK" )
				var svgHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" id="double-check"><path class="svg-path" fill="#212529" fill-rule="evenodd" d="M16.5303 6.46967C16.8232 6.76256 16.8232 7.23744 16.5303 7.53033L6.53033 17.5303C6.38968 17.671 6.19891 17.75 6 17.75 5.80109 17.75 5.61032 17.671 5.46967 17.5303L1.46967 13.5303C1.17678 13.2374 1.17678 12.7626 1.46967 12.4697 1.76256 12.1768 2.23744 12.1768 2.53033 12.4697L6 15.9393 15.4697 6.46967C15.7626 6.17678 16.2374 6.17678 16.5303 6.46967zM22.5303 6.46966C22.8232 6.76254 22.8232 7.23742 22.5303 7.53032L12.5308 17.5303C12.2379 17.8232 11.7631 17.8232 11.4702 17.5304L9.96975 16.0304C9.67681 15.7376 9.67674 15.2627 9.96959 14.9697 10.2624 14.6768 10.7373 14.6767 11.0303 14.9696L12.0004 15.9394 21.4697 6.46968C21.7625 6.17678 22.2374 6.17677 22.5303 6.46966z" clip-rule="evenodd"></path></svg>';

			}
			// Set the innerHTML of the span to the SVG HTML
			msgcheck.innerHTML = svgHTML;

			// Append the span to the document or wherever you want to display it
			div1.appendChild(msgcheck); // Add it to the body as an example

			// // msgP.innerHTML = <i class="fa-solid fa-check"></i>
			// msgcheck.classList.add("fa-solid")
			// msgcheck.classList.add("fa-check")
			// div1.appendChild(msgcheck)

			
		}

		newMessageDiv.appendChild(div1)

		if (isNewMessage) {
			chatLog.insertBefore(newMessageDiv, chatLog.firstChild)
		}
		else {
			chatLog.appendChild(newMessageDiv)
		}

		if (!maintainPosition) {
			chatLog.scrollTop = chatLog.scrollHeight
		}

		{% comment %} preloadImage(profile_image, profile_image_id) {% endcomment %}
	}



	function createConnectedDisconnectedElement(msg, msd_id, uniName, user_id) {
		var chatLog = document.getElementById("id_chat_log")

		var newMessageDiv = document.createElement("div")
		newMessageDiv.classList.add("d-flex")
		newMessageDiv.classList.add("flex-row")
		newMessageDiv.classList.add("message-container")

		{% comment %} var profileImage = document.createElement("img")
		profileImage.addEventListener("click", function (e) {
			selectUser(user_id)
		})
		profileImage.classList.add("profile-image")
		profileImage.classList.add("rounded-circle")
		profileImage.classList.add("img-fluid")
		profileImage.src = "{% static 'codingwithmitch/dummy_image.png' %}"
		var profile_image_id = "id_profile_image_" + msg_id
		profileImage.id = profile_image_id
		newMessageDiv.appendChild(profileImage) {% endcomment %}

		var usernameSpan = document.createElement("span")
		usernameSpan.innerHTML = msg
		usernameSpan.classList.add("username-span")
		usernameSpan.addEventListener("click", function (e) {
			selectUser(user_id)
		})
		newMessageDiv.appendChild(usernameSpan)

		chatLog.insertBefore(newMessageDiv, chatLog.firstChild)

		// preloadImage(profile_image, profile_image_id)
	}

	function setPageNumber(pageNumber) {
		document.getElementById("id_page_number").innerHTML = pageNumber
	}

	function clearChatLog() {
		document.getElementById("id_chat_log").innerHTML = ""
	}


	function setPaginationExhausted() {
		setPageNumber("-1")
	}

	/*
	  Retrieve the chat room messages given the page number.
  */
	function getRoomChatMessages() {
		var pageNumber = document.getElementById("id_page_number").innerHTML
		if (pageNumber != "-1") {
			setPageNumber("-1") // loading in progress
			chatSocket.send(JSON.stringify({
				"command": "get_room_chat_messages",
				"room_id": roomId,
				"page_number": pageNumber,
			}));
		}
	}

			// Function to be called on anchor tag click
	function yourFunction(msg_id) {
		// Your JavaScript code here
		console.log("Anchor tag clicked!");
		chatSocket.send(JSON.stringify({
			"command": "delete_message",
			"room_id": roomId,
			"sender_id" : '{{request.user.id}}',
			"msg_id" : msg_id,
			
		}));
	}
	var divr1 = document.createElement("div");
	function replyFunction(msg_id,name) {
		if (document.getElementById('myDiv')!==null){
			console.log("removed!!!");
			document.getElementById('myDiv').remove();
		}else{
			console.log("not removed",document.getElementById('myDiv'));
		}
		document.getElementById('id_chat_message_input').focus();
  // Your JavaScript code here
  window.userx=name;

  
  var text1 = document.getElementById("msgdiv-" + msg_id).firstChild.childNodes[1].firstChild.textContent;
  window.textoo = document.createElement("span");
  
  textoo.textContent = text1;
  textoo.id="replytext";
  textoo.classList.add('truncate-text')
  textoo.classList.add('my-lappy-textoo')
  window.rep_id = msg_id

  
  var divr = document.createElement("div");
  divr.id = "myDiv";  // Apply CSS styles using this ID

  var crossIcon = document.createElement("i");
  crossIcon.classList.add("fas", "fa-times"); 
  crossIcon.style.cursor = "pointer";  // Show a pointer cursor
  


if (window.innerWidth <= 600) {
      crossIcon.style.position = "absolute";
      
    }
crossIcon.style.right = "10px";
crossIcon.style.top = "10px";
crossIcon.style.margin = "5px"
  divr.appendChild(crossIcon);


  // Create text nodes and icon (assuming Font Awesome is included):
  var replyIcon = document.createElement("i");
  replyIcon.classList.add("fas", "fa-reply");
  replyIcon.style.fontSize = "10px";
  window.textr = document.createElement("span");
  {% comment %} textr.textContent = "{{request.user.name}}"; {% endcomment %}
  textr.textContent = userx;
  textr.id="replyme";
 // Make username bold

  // Create line breaks:@
  {% comment %} var br1 = document.createElement("br");
  var br2 = document.createElement("br"); {% endcomment %}
  var replto=document.createElement("div");
  // Append nodes in the correct order:
  divr.appendChild(replyIcon);
  divr.appendChild(textr);
  textr.style.margin = "5px";
  textr.style.fontSize = "12px";
  {% comment %} divr.appendChild(br1); {% endcomment %}
  divr.appendChild(textoo);  // Append as a text node
  textoo.style.marginLeft="15px";
  {% comment %} divr.appendChild(br2); {% endcomment %}
  divr1.appendChild(divr);
  divr.style.borderRadius="15px";
  divr.style.padding="10px 15px";

  {% if not request.user_agent.is_mobile %}
 
  divr.style.position="absolute";
  divr.style.bottom="3.5em";
  divr.style.background="#efefef";
  divr.style.width="95%";
  divr.style.borderRadius="10px";

  textoo.style.overflow = 'hidden';
  textoo.style.display = '-webkit-box';
  textoo.style.webkitBoxOrient = 'vertical';
  textoo.style.webkitLineClamp = '1';
  textoo.style.textOverflow = 'ellipsis';

 
  {% endif %}
  
  {% comment %} document.getElementById("id_chat_message_input").insertAdjacentElement("beforebegin", divr); {% endcomment %}
  document.getElementById("id_chat_message_input").parentNode.insertBefore(divr1, document.getElementById("id_chat_message_input"));

  crossIcon.addEventListener("click", function() {
    document.getElementById('myDiv').remove();  // Remove the div when clicked
	
  });
}




	function handleMessagesPayload(messages, new_page_number) {
		if (messages != null && messages != "undefined" && messages != "None") {
			setPageNumber(new_page_number)
			// console.log("The messages are ------------ ",messages)
			messages.forEach(function (message) {
				appendChatMessage(message, true, false, auth_user_id,null)
				console.error(message)
			})
		}
		else {
			setPaginationExhausted() // no more messages
		}
	}

	/*
		Get the next page of chat messages when scrolls to bottom
	*/
	function chatLogScrollListener(e) {
		var chatLog = document.getElementById("id_chat_log")
		if ((Math.abs(chatLog.scrollTop) + 2) >= (chatLog.scrollHeight - chatLog.offsetHeight)) {
			getRoomChatMessages()
		}
	}

	/*
		Enable the function "chatLogScrollListener"
	*/
	function enableChatLogScrollListener() {
		document.getElementById("id_chat_log").addEventListener("scroll", chatLogScrollListener);
	}

	/*
		Disable the function "chatLogScrollListener"
	*/
	function disableChatLogScrollListener() {
		document.getElementById("id_chat_log").removeEventListener("scroll", chatLogScrollListener)
	}

	function displayChatroomLoadingSpinner(isDisplayed) {
		// console.log("displayChatroomLoadingSpinner: " + isDisplayed)
		var spinner = document.getElementById("id_chatroom_loading_spinner")
		if (isDisplayed) {
			spinner.style.display = "block"
		}
		else {
			spinner.style.display = "none"
		}
	}

	function highlightFriend(userId) {
		// select new friend
		document.getElementById("id_friend_container_" + userId).style.background = "#343a40"
		document.getElementById("id_friend_container_" + userId).style.color = "white"
		document.getElementById("id_friend_count_" + userId).style.display = "none"
		var countElement = document.getElementById("id_msg_notifications_count")
		countElement.style.background = "transparent"
		countElement.style.display = "none"
	}

	function clearHighlightedFriend() {
		{% if m_and_f %}
		{% for x in m_and_f %}
		document.getElementById("id_friend_container_{{x.friend.id}}").style.background = ""
		document.getElementById("id_friend_container_{{x.friend.id}}").style.color = "black"
		{% endfor %}
		{% endif %}

		// clear the profile image and username of current chat
		document.getElementById("id_other_username").innerHTML = ""
	}

	function createOrReturnPrivateChat(id) {
		payload = {
			"csrfmiddlewaretoken": "{{ csrf_token }}",
			"user2_id": id,
		}
		$.ajax({
			type: 'POST',
			dataType: "json",
			url: "{% url 'chat:create-or-return-private-chat' %}", // production
			data: payload,
			timeout: 5000,
			success: function (data) {
				console.log("SUCCESS", data)
				if (data['response'] == "Successfully got the chat.") {
					setupWebSocket(data['chatroom_id'])
				}
				else if (data['response'] != null) {
					alert(data['response'])
				}
			},
			error: function (data) {
				console.error("ERROR...", data)
				alert("Something went wrong.")
			},
		});
	}


	

	var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
	var ws2_path = ws_scheme + '://' + window.location.host + "/mchat-notif/"; // development
	{% comment %} var ws2_path = ws_scheme + '://' + window.location.host + ":8001/mchat-notif/"; // production {% endcomment %}


	// console.log("Connecting to " + ws_path);
	chatNotifSocket = new WebSocket(ws2_path);

	// Handle incoming messages
	chatNotifSocket.onmessage = function (message) {
		// Decode the JSON
		// console.log("Got chat websocket message " + message.data);
		// console.log("Got websocket message.");
		var data = JSON.parse(message.data);

		if (data.receive_unread_msg_count) {
			// Gotta update the UI with new count
			// console.log(data.payload_dict)
			updateUnreadGeneralNotificationsCount(data.payload_dict);
		}


	}

	chatNotifSocket.addEventListener("open", function (e) {
		console.log("ChatNotifSocket OPEN")
		startMsgNotificationService()
	})

	chatNotifSocket.onclose = function (e) {
		console.log('Chat Notif socket closed.');
	};

	chatNotifSocket.onOpen = function (e) {
		console.log("ChatNotifSocket onOpen", e)
	}

	chatNotifSocket.onerror = function (e) {
		console.log('ChatNotifSocket error', e)
	}

	if (chatNotifSocket.readyState == WebSocket.OPEN) {
		console.log("ChatNotifSocket OPEN")
	} else if (chatNotifSocket.readyState == WebSocket.CONNECTING) {
		console.log("ChatNotifSocket connecting..")
	}


</script>


{% endblock body %}